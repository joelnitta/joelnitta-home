{
  "hash": "84f5fb3ea3aa7430a3c698d711374482",
  "result": {
    "markdown": "---\ntitle: canaperがCRANに登録されました\ndescription: Rパッケージcanaperの紹介\nbibliography: references.yaml\ndate: 2022-10-07\ndate-modified: today\nimage: https://docs.ropensci.org/canaper/logo.png\ncitation:\n  url: https://www.joelnitta.com/posts/canaper/\ncategories:\n  - R\n  - Spatial phylogenetics\nknitr:\n  opts_chunk: \n      cache: true\nlang: ja\n---\n\n\n## `canaper`への紹介\n\n\n\n\n\n(Read this blogpost in\n[English](https://www.joelnitta.com/posts/2022-10-07_canaper/))\n\n[`canaper`](https://github.com/ropensci/canaper)\nv1.0.0が[CRAN](https://cran.r-project.org/web/packages/canaper/index.html)に登録されました！今までいくつかのRパッケージを書いてGitHubで公開したことがありますが、自分のパッケージがCRANに登録されるのが初めてです。\n\nそもそも、`canaper`って一体何だろう？\n\nパッケージの[DESCRIPTION](https://github.com/ropensci/canaper/blob/main/DESCRIPTION)にはこのような文章があります：\n\n> `canaper` provides functions to analyze the spatial distribution of\nbiodiversity, in particular categorical analysis of neo- and paleo-endemism\n(CANAPE) as described in Mishler et al (2014) [doi:10.1038/ncomms5473](https://doi.org/10.1038/ncomms5473).\n`canaper` conducts statistical tests to determine the types of endemism that\noccur in a study area while accounting for the evolutionary relationships of\nspecies.\n\nつまり、`canaper`は生物多様性の地理的分布を解析する関数を提供します。特に、生物の進化的な関係を考慮しながら、ある地域における固有性の種類を統計的に検証する、categorical\nanalysis of neo- and\npaleo-endemism（CANAPE）というMishler等（2014）<doi:10.1038/ncomms5473>\nが開発した解析を行います。\n\nもしも上の話を読んで「面白い！」と思ったら、是非続きを読んでください。\n\n## 系統的固有性とCANAPE\n\n[生物多様性](https://ja.wikipedia.org/wiki/%E7%94%9F%E7%89%A9%E5%A4%9A%E6%A7%98%E6%80%A7)は種数、つまり、ある地域における種の数で測られることがよくあります。それと同じように、固有性はある地域にしか生息しない種の数で測ることがよくあります。しかし、このような、種名だけを使うアプローチは種の進化的な歴史を考慮しません。最近、[分子系統樹](https://ja.wikipedia.org/wiki/%E7%B3%BB%E7%B5%B1%E6%A8%B9)の増加によって、種の進化的な歴史を考慮した生物多様性を測定する方法がいくつか開発されました。その一つは系統的固有性[Phylogenetic\nendemism, PE\\; @Rosauer2009]です。PEは種ではなく、系統樹の枝によって固有性を測る方法です。\n\nPEを使うことによって、**生物多様性を生み出す進化的なプロセス**を垣間見ることができる。例えば、PEの高い、短い枝が密集している地域は最近の種分化（放散）によってできた可能性があり、このような地域を「neo-endemic」と呼びます。一方で、PEの高い、長い枝が密集している地域はかつて広く分布していた系統が多く絶滅したことによってできた可能性が高く、このような地域を「paleo-endemic」と呼びます。このような地域の区別をするために、@Mishler2014\nがCANAPEという方法を開発しました。\n\n`canaper`の目的はRでCANAPEを行うことです。\n\n## 実例：オーストラリアのアカシア\n\n![*Acacia\npycnantha*、写真[Bidgee](https://commons.wikimedia.org/wiki/User:Bidgee)](Golden-wattle.jpg)\n\n`canaper`には元々のCANAPEの論文で解析されたデータセットが備えられています。オーストラリア産のアカシア^[アカシアはオーストラリアの被子植物の中で最も種が多い属です。１０００種近くあります。]\nのデータです。系統樹とコミュニティマトリックス（群集⾏列）からなっています。このデータセットを用いて簡単なデモを行います^[なお、本デモに使う解析設定は都合上使っているだけで、本格的な解析にはおすすめしません。]。\n\nここで詳細には入りませんが、[この例](https://docs.ropensci.org/canaper/articles/canape.html)についてもっと知りたければ、[`canaper`のウェブサイト](https://docs.ropensci.org/canaper/index.html)をご覧ください。\n\nCANAPE解析の全部を二つのコマンドだけでできます：[`cpr_rand_test()`](https://docs.ropensci.org/canaper/reference/cpr_rand_test.html)と\n[`cpr_classify_endem()`](https://docs.ropensci.org/canaper/reference/cpr_classify_endem.html)。\n\n\n::: {.cell hash='index.ja_cache/html/acacia-demo_c4c990c69cb4fdced937f3ba04add874'}\n\n```{.r .cell-code}\nlibrary(canaper)\nlibrary(tidyverse)\n\n# 再現のためにシードを設定する\nset.seed(12345)\n\n# 1. ランダム化比解析を行う\nacacia_rand_res <- cpr_rand_test(\n  acacia$comm, acacia$phy,\n  null_model = \"curveball\",\n  n_reps = 99, n_iterations = 10000,\n  tbl_out = TRUE\n)\n\n# 2. 固有性を分類化する\nacacia_canape <- cpr_classify_endem(acacia_rand_res)\n```\n:::\n\n\nでは、アウトプットをみてみましょう。\n\n[`cpr_rand_test`](https://docs.ropensci.org/canaper/reference/cpr_rand_test.html)がたくさん（全部で５４）の列を返します。コミュニティの各地点について、様々な（PEを含めた）指標です。\n\n\n::: {.cell hash='index.ja_cache/html/acacia-rand-res_944208288ef326cb60de11656f92ad9e'}\n\n```{.r .cell-code}\nacacia_rand_res\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 3,037 × 55\n   site    pd_obs pd_rand_mean pd_rand_sd pd_obs_z pd_obs_c_upper pd_obs_c_lower\n   <chr>    <dbl>        <dbl>      <dbl>    <dbl>          <dbl>          <dbl>\n 1 -1025… 0.0145        0.0227    0.00506  -1.62                1             98\n 2 -1025… 0.0382        0.0497    0.00745  -1.54                8             91\n 3 -1025… 0.0378        0.0369    0.00635   0.138              55             44\n 4 -1025… 0.0570        0.0613    0.00829  -0.517              33             66\n 5 -1025… 0.0409        0.0419    0.00614  -0.172              41             58\n 6 -1025… 0.00998       0.0101    0.00193  -0.0429             49             48\n 7 -1025… 0.0187        0.0225    0.00393  -0.958              19             80\n 8 -1025… 0.0434        0.0536    0.00902  -1.14               15             84\n 9 -1025… 0.0111        0.0101    0.00197   0.495              81             18\n10 -1025… 0.0903        0.0876    0.0112    0.240              61             38\n# ℹ 3,027 more rows\n# ℹ 48 more variables: pd_obs_q <dbl>, pd_obs_p_upper <dbl>,\n#   pd_obs_p_lower <dbl>, pd_alt_obs <dbl>, pd_alt_rand_mean <dbl>,\n#   pd_alt_rand_sd <dbl>, pd_alt_obs_z <dbl>, pd_alt_obs_c_upper <dbl>,\n#   pd_alt_obs_c_lower <dbl>, pd_alt_obs_q <dbl>, pd_alt_obs_p_upper <dbl>,\n#   pd_alt_obs_p_lower <dbl>, rpd_obs <dbl>, rpd_rand_mean <dbl>,\n#   rpd_rand_sd <dbl>, rpd_obs_z <dbl>, rpd_obs_c_upper <dbl>, …\n```\n:::\n:::\n\n\n[`cpr_classify_endem()`](https://docs.ropensci.org/canaper/reference/cpr_classify_endem.html)がもう一つの列をデータに付けます。新しい列は固有性の種類です。それぞれの種類が何回観察されたのか、数えてみましょう：\n\n\n::: {.cell hash='index.ja_cache/html/acacia-endem-res_396287babc688073966c22406070b19e'}\n\n```{.r .cell-code}\ncount(acacia_canape, endem_type)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 5 × 2\n  endem_type          n\n  <chr>           <int>\n1 mixed             176\n2 neo                 5\n3 not significant  2827\n4 paleo              12\n5 super              17\n```\n:::\n:::\n\n\nそして、今回計算した固有性の種類を地図にするとこうなります：\n\n\n::: {.cell hash='index.ja_cache/html/acacia-plot_0619210bbd75cb9d3f9c66b0ddf9cae5'}\n\n```{.r .cell-code  code-fold=\"true\"}\n# まず、図を作るためにデータをちょっといじる\n# （経緯度の列を加える）\nacacia_canape <- acacia_canape |>\n  separate(site, c(\"long\", \"lat\"), sep = \":\") |>\n  mutate(across(c(long, lat), parse_number))\n\n# 図のテーマをいじる\ntheme_update(\n  panel.background = element_rect(fill = \"white\", color = \"white\"),\n  panel.grid.major = element_line(color = \"grey60\"),\n  panel.grid.minor = element_blank()\n  )\n\nggplot(acacia_canape, aes(x = long, y = lat, fill = endem_type)) +\n  geom_tile() +\n  # cpr_endem_cols_4 はcanaperに入っているカラーユニバーサルデザインのパレット\n  scale_fill_manual(values = cpr_endem_cols_4) +\n  coord_fixed() +\n  guides(\n    fill = guide_legend(title.position = \"top\", label.position = \"bottom\")\n  ) +\n  theme(legend.position = \"bottom\", legend.title = element_blank())\n```\n\n::: {.cell-output-display}\n![](index.ja_files/figure-html/acacia-plot-1.png){width=672}\n:::\n:::\n\n\n## rOpenSci\n\nもう一つ今回で初めてだったのが[ROpenSci](https://ropensci.org/)にパッケージを投稿することでした。rOpenSciはRで書かれた研究用のソフトを支援する団体です。もし自分の研究用のパッケージを公開しようと考えているなら、とてもおすすめです。\n\nというのは、まずはRパケージの書き方について非常に丁寧な説明書を提供しているからです。また、パッケージの自動的なチェックを行うパッケージも。これを使うだけでも自分のコードの腕がかなり上がりました。\n\n次に、rOpenSciに投稿されたパッケージは徹底的な[コードレビュー](https://devguide.ropensci.org/softwarereviewintro.html)（査読）を受けることになっています。こうすることによって、自分だけではなかなか気づかなかったことを教えていただき、さらに[コードの改善](https://github.com/ropensci/software-review/issues/475)につながりました^[査読者の[Klaus\nSchliep](https://github.com/KlausVigo)と[Luis\nOsorio](https://github.com/luismurao)、そして編集者の[Toby\nHocking](https://github.com/tdhock)に感謝しています！]。\n\nしかし、何と言っても、やはりrOpenSciのコミュニティが素晴らしいです。とてもアクティブで広く開かれたコミュニティです。活動としては、[Community\nCall](https://ropensci.org/commcalls/)（誰でも参加できるビデオコール）、[バーチャルコーワークスペース](https://ropensci.org/events/)、やSlackのチャットチャンネルがあります。\n\nご興味のある方は是非試してくださいね！そして、rOpenSciに感謝します!\n\n## 参考情報\n\n`canaper`についてもっと知りたい方は[GitHubのサイト](https://github.com/ropensci/canaper)、[パッケージのサイト](https://docs.ropensci.org/canaper)、および[プレプリント](https://doi.org/10.1101/2022.10.06.511072)をご覧下さい。\n\n## 参考文献\n\n::: {#refs}\n:::\n\n## 再現性 {.appendix}\n\n- [ソースコード](https://github.com/joelnitta/joelnitta-home/tree/main/posts/2022-10-07_canaper/index.ja.qmd)\n- [`renv`のロックファイル](https://github.com/joelnitta/joelnitta-home/tree/main/posts/2022-10-07_canaper/renv.lock)\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}